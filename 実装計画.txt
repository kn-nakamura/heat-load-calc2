Heat Load Calc MVP 実装計画（決定完了版） Summary 本計画は、ver3.0_熱負荷計算書.xlsx を仕様書として熱負荷計算を再実装し、熱負荷計算書テンプレート.xlsx（様式001〜006）へ差し込み出力できる Web アプリを構築する。 MVPは frontend(React+Vite) と backend(FastAPI+Python) を分離し、入力は手入力・Excelコピペ・CSV・JSON、保存は project.json の読み書き中心、計算はバックエンドAPIで実施する。 一致判定は「例題1/2の主要セル完全一致」を採用する。
Fixed decisions 配備形態: 社内Web前提（複数ユーザー利用可能な分離構成）。 フロント基盤: React + Vite + TypeScript。 グリッド: AG Grid Community。 保存方式: JSONファイル中心（サーバーDBなし）。 Excel出力対象: 熱負荷計算書テンプレート.xlsx の6様式のみ。 UI言語: 日本語のみ。 Excel一致基準: 主要出力セルの完全一致（0差）。 一括取込ルール: Upsert既定（同一IDは更新、新規は追加、削除は明示操作時のみ）。
Repository structure frontend/ backend/ backend/app/api/ FastAPI routers backend/app/models/ Pydantic schema backend/app/domain/ 計算ロジック backend/app/services/ import/export/calc orchestration backend/reference_data/ 参照テーブルJSON backend/scripts/ Excel参照表抽出スクリプト backend/tests/ unit/integration/golden docs/ API・計算仕様・丸め規約
Public APIs / interfaces POST /v1/projects/validate POST /v1/calc/run POST /v1/import/csv/preview POST /v1/import/csv/apply POST /v1/import/paste/preview POST /v1/import/paste/apply POST /v1/import/json POST /v1/export/json POST /v1/export/excel GET /v1/reference/{table_name}
Core types (Pydantic) Project: id, name, unit_system, region, orientation_basis, design_conditions, rooms, surfaces, openings, constructions, glasses, internal_loads, ventilation_infiltration, systems, metadata。 DesignCondition: season(summer/winter), indoor_temp_c, indoor_rh_pct, schedule_profile_id。 Room: id, name, usage, floor, area_m2, ceiling_height_m, volume_m3, design_condition_id, system_id。 Surface: id, room_id, kind(wall/roof/floor/internal), orientation, width_m, height_m, area_m2, adjacent_type, construction_id, etd_profile_key。 Opening: id, room_id, surface_id, orientation, width_m, height_m, area_m2, glass_id, shading_sc, solar_area_ratio_pct。 ConstructionAssembly: id, name, u_value_w_m2k, wall_type, notes。 GlassSpec: id, name, solar_gain_key, u_value_w_m2k。 InternalLoad: id, room_id, kind(lighting/occupancy/equipment), sensible_w, latent_w, schedule_id。 VentilationInfiltration: id, room_id, outdoor_air_m3h, infiltration_mode, sash_type, airtightness, wind_speed_ms。 System: id, name, room_ids。 CalcTrace: formula_id, entity_type, entity_id, mode, inputs, references, intermediates, output。 ValidationIssue: level(error/warn), code, message, entity, field, row, col。
Calculation architecture psychrometrics.py 温湿度→飽和蒸気圧/絶対湿度/比エンタルピー。 reference_lookup.py 屋外条件・ETD・日射・隙間風テーブル検索。 transmission.py 構造体・ガラス面通過熱。 solar_gain.py ガラス日射負荷。 internal_loads.py 照明・人体・機器。 ventilation.py 換気・侵入。 aggregation.py 室別/系統別/総合集計。 rounding.py Decimal + ROUND_HALF_UPで丸めタイミング固定。 signs.py 内部符号統一、表示時に冷房/暖房へ分離。 すべての主要計算は CalcTrace を返し、UIの根拠展開に利用。
Reference data externalization 入力元: ver3.0_熱負荷計算書.xlsx の以下5シート。 【表】設計用屋外温度 / 【表】実行温度差 / 【表】ガラス面標準日射取得 / 【表】アルミサッシの隙間風量 / 【表】その他 extract_reference_tables.py を作成し、テーブル単位で JSON 出力。 JSONメタ情報: version, source_file, source_sheet, units, keys, generated_at。 【表】その他 は複数テーブルに分割し、個別キーで管理。 再生成コマンドをドキュメント化し、ユーザー編集後の再読込を可能にする。
Import / paste behavior CSV最小必須: rooms.csv, surfaces.csv, openings.csv。 任意CSV: constructions.csv, glasses.csv, internal_loads.csv, ventilation.csv。 ヘッダーありを標準、ヘッダーなしは設定で許可。 日本語列名・英語別名を辞書で正規化。 preview で追加/更新/削除(明示時のみ)/影響範囲を提示。 apply 実行前に確定操作必須。 エラーはセル単位で返し、グリッドでハイライト。 参照切れ、重複ID、型不正、単位不整合を検出。
Excel export design 熱負荷計算書テンプレート.xlsx を複製して値差し込み。 既存書式・既存数式は保持。 workbook.calculation.fullCalcOnLoad = True を維持。 シート名はトリム比較で解決し、様式003 の末尾スペース差異に耐性を持たせる。 入力セルマッピングは excel_mapping.yml で外部定義。 テンプレ不足セルの数式注入は excel_formula_injection.yml で管理（評価はExcel側のみ）。
Frontend wizard プロジェクト基本条件 設計条件 屋外条件 窓・ガラス設定 構造体設定 室登録 系統登録 負荷確認（内訳＋根拠展開） 出力（Excel/JSON） 左ナビ＋ステップ進行、各ステップで保存可能、未解決エラー件数を表示。
Test plan and acceptance criteria 単体試験: 参照テーブル検索、丸め、単位換算、符号変換。 統合試験: POST /v1/calc/run で例題1/2データの主要セル一致。 主要一致セル（例題1）: R48 X48 AB48 AF48 AL48 R50 X50 AB50 AF50 AJ50 AL50 R52 X52 AB52 AF52 AJ52 AL52 R53 X53 AB53 AF53 AJ53 AL53 R54 X54 AB54 AF54 AJ54 R55 X55 AB55 AF55 AJ55。 主要一致セル（例題2）: N48 R48 X48 AB48 AF48 N50 R50 X50 AB50 AF50 N52 R52 X52 AB52 AF52 N53 R53 X53 AB53 AF53 R54 X54 AB54 AF54 R55 X55 AB55 AF55。 Import試験: ヘッダー別名、重複ID Upsert、参照切れ、数値不正。 Export試験: 出力xlsxで書式保持、数式保持、fullCalcOnLoad=True。 E2E試験: Wizardで入力→計算→根拠表示→Excel/JSON出力まで通し確認。
Execution phases フェーズ1: スキーマ確定とAPI雛形。 フェーズ2: グリッド編集 + JSON import/export。 フェーズ3: CSV/コピペ preview/apply + バリデーション。 フェーズ4: 参照表抽出スクリプトとJSON同梱。 フェーズ5: 計算エンジン実装（例題一致を先に通す）。 フェーズ6: 根拠展開付き結果ビュー。 フェーズ7: Excel出力（テンプレ差し込み）。 フェーズ8: テスト強化と受け入れ判定。 フェーズ9: MVPリリース文書化（運用手順・制約・将来IFC拡張ポイント）。
Assumptions and defaults 認証・権限はMVP対象外。 サーバー永続DBは導入しない。 PDF/CSV出力は設計余地のみ、MVP必須はExcel/JSON。 IFC importはAPI拡張点のみ実装（実機能は次段階）。 計算はPython側で完結し、サーバーでExcel再計算は行わない。 UIは日本語固定、単位は表示変換可だが内部SI統一。
